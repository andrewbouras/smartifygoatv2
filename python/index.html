<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>MCQ Viewer</title>
<style>
  body {
    font-family: sans-serif;
    max-width: 600px;
    margin: 20px auto;
    line-height: 1.5;
    background-color: #1a1a1a;
    color: #e0e0e0;
  }
  .question-block {
    border: 1px solid #444;
    padding: 15px;
    margin-bottom: 20px;
    border-radius: 4px;
    background-color: #2a2a2a;
  }
  .question-block h2 {
    margin: 0 0 10px;
    font-size: 1.1rem;
    color: #fff;
  }
  .choices {
    margin-bottom: 10px;
  }
  .choice {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
  }
  .choice input {
    margin-right: 10px;
  }
  .choice label {
    color: #e0e0e0;
  }
  .explanation {
    background: #333;
    padding: 10px;
    border-left: 4px solid #555;
    margin-top: 10px;
    font-size: 0.9rem;
  }
  .correct {
    background-color: #1b3320;
    border-left-color: #2d5a3c;
  }
  .incorrect {
    background-color: #3d2020;
    border-left-color: #5a2d2d;
  }
  .factoid {
    font-size: 0.8rem;
    color: #aaa;
    margin-top: 5px;
  }
  .question-block.completed {
    opacity: 0.7;
  }
  .choice.correct {
    background-color: #e7f7e7;
  }
  .choice.incorrect {
    background-color: #ffe7e7;
  }
</style>
</head>
<body>

<h1>MCQ Practice</h1>
<div id="error-display" style="background: #3d2020; color: #fff; padding: 10px; margin: 10px 0; display: none;"></div>
<div style="margin-bottom: 20px;">
    <a href="/mcq/incorrects.html" style="color: #4a9eff; text-decoration: none;">View Incorrect Answers</a>
</div>
<div id="mcq-container">Loading MCQs...</div>

<script>
  // Helper function to show errors visibly
  function showError(message) {
    const errorDiv = document.getElementById('error-display');
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
  }

  console.log('Script started - if you see this, JavaScript is running');
  showError('Script started - checking if errors are visible');
  
  async function loadMCQs() {
    try {
        console.log('loadMCQs function called');
        // Get the bank ID from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const bankId = urlParams.get('bank');
        console.log('Loading bank:', bankId);
        
        // Load questions based on bank ID
        let response;
        let sourceFile;
        
        if (bankId === 'mehlman-microbiology') {
            sourceFile = 'Mehlman Microbiology_factoids.json';
        } else if (bankId === 'mehlman-anatomy') {
            sourceFile = 'Mehlman Anatomy_factoids.json';
        } else {
            throw new Error('Invalid question bank ID');
        }

        // Use the API endpoint for both banks
        const url = `/api/questionbank/${sourceFile}`;
        console.log('Fetching from:', url);
        response = await fetch(url, {
            credentials: 'include',
            headers: {
                'Accept': 'application/json'
            }
        });

        console.log('Response status:', response.status);
        if (!response.ok) {
            const text = await response.text();
            console.error('Error response:', text);
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        console.log('Got response, parsing JSON...');
        const data = await response.json();
        console.log('Received data:', data);
        
        const mcqs = data.mcqs || data.questions || [];
        const userProgress = data.userProgress || { lastQuestionIndex: 0, answers: [] };
        
        console.log('User progress:', userProgress);
        console.log('First MCQ:', mcqs[0]);
        console.log('Total MCQs:', mcqs.length);
        
        if (!mcqs || mcqs.length === 0) {
            throw new Error('No questions found in this bank');
        }
        
        displayMCQs(mcqs, userProgress);
    } catch (error) {
        console.error('Error loading MCQs:', error);
        const container = document.getElementById('mcq-container');
        container.innerHTML = `
            <div style="color: red; padding: 20px;">
                <h2>Error loading MCQs</h2>
                <p>${error.message}</p>
                <pre>${error.stack}</pre>
                <p>Bank ID: ${urlParams.get('bank')}</p>
                <p>URL: ${window.location.href}</p>
            </div>
        `;
    }
  }

  function showExplanation(mcq, block, selectedValue) {
    // Remove existing explanation if any
    const oldExp = block.querySelector('.explanation');
    if (oldExp) oldExp.remove();

    const explanationDiv = document.createElement('div');
    explanationDiv.className = 'explanation';

    const correctChoice = mcq.answerChoices.find(c => c.correct);
    const isCorrect = correctChoice && selectedValue === correctChoice.value;

    if (isCorrect) {
        explanationDiv.classList.add('correct');
        explanationDiv.textContent = 'Correct! ' + mcq.explanation;
    } else {
        explanationDiv.classList.add('incorrect');
        explanationDiv.textContent = 'Incorrect. The correct answer is: ' + 
            (correctChoice ? correctChoice.value : 'No correct answer found') + '. ' + mcq.explanation;
        
        // Log incorrect answer
        logIncorrectAnswer(mcq.id, mcq.factoid);
    }

    // Factoid section
    const factoidDiv = document.createElement('div');
    factoidDiv.className = 'factoid';
    factoidDiv.textContent = 'Factoid: ' + mcq.factoid;

    explanationDiv.appendChild(factoidDiv);
    block.appendChild(explanationDiv);
    
    // Add scroll to next question
    scrollToNextQuestion(block);
  }

  function displayMCQs(mcqs, userProgress) {
    const container = document.getElementById('mcq-container');
    container.innerHTML = '';
    
    mcqs.forEach((mcq, index) => {
        const block = document.createElement('div');
        block.className = 'question-block';
        if (index < userProgress.lastQuestionIndex) {
            block.classList.add('completed');
        }
        
        // Question title
        const qTitle = document.createElement('h2');
        qTitle.textContent = (index + 1) + '. ' + mcq.question;
        block.appendChild(qTitle);
        
        // Choices
        const choicesDiv = document.createElement('div');
        choicesDiv.className = 'choices';
        
        // Sort answer choices alphabetically by value
        const sortedChoices = [...mcq.answerChoices].sort((a, b) => 
            a.value.localeCompare(b.value)
        );
        
        // Check if user has answered this question
        const userAnswer = userProgress.answers.find(a => a.questionId === mcq.id);
        
        sortedChoices.forEach((choice, choiceIndex) => {
            const choiceDiv = document.createElement('div');
            choiceDiv.className = 'choice';
            
            const input = document.createElement('input');
            input.type = 'radio';
            input.name = 'q' + index;
            input.value = choice.value;
            input.id = 'q' + index + 'c' + choiceIndex;
            
            // If user has answered this question, show their answer
            if (userAnswer) {
                if (userAnswer.selectedAnswer === choice.value) {
                    input.checked = true;
                    choiceDiv.classList.add(userAnswer.isCorrect ? 'correct' : 'incorrect');
                }
                input.disabled = true;
            } else {
                input.addEventListener('change', async () => {
                    const isCorrect = choice.correct;
                    await saveAnswer(mcq.id, choice.value, isCorrect);
                    showExplanation(mcq, block, choice.value);
                });
            }
            
            const label = document.createElement('label');
            label.htmlFor = input.id;
            label.textContent = choice.value;
            
            choiceDiv.appendChild(input);
            choiceDiv.appendChild(label);
            choicesDiv.appendChild(choiceDiv);
        });
        
        block.appendChild(choicesDiv);
        
        // If user has answered, show explanation
        if (userAnswer) {
            showExplanation(mcq, block, userAnswer.selectedAnswer);
        }
        
        container.appendChild(block);
    });
    
    // Scroll to last unanswered question
    const blocks = document.querySelectorAll('.question-block');
    const firstUnanswered = Array.from(blocks).find(block => !block.classList.contains('completed'));
    if (firstUnanswered) {
        firstUnanswered.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  }

  function scrollToNextQuestion(block) {
    // Wait 1 second before scrolling
    setTimeout(() => {
        // Get the next question block
        const nextBlock = block.nextElementSibling;
        if (nextBlock && nextBlock.classList.contains('question-block')) {
            // Calculate position to center the next question
            const windowHeight = window.innerHeight;
            const nextBlockRect = nextBlock.getBoundingClientRect();
            const scrollTo = window.pageYOffset + nextBlockRect.top - (windowHeight/2) + (nextBlockRect.height/2);
            
            // Smooth scroll
            window.scrollTo({
                top: scrollTo,
                behavior: 'smooth'
            });
        }
    }, 1000); // 1 second delay
  }

  function getMostCenteredQuestion() {
    const questions = document.querySelectorAll('.question-block');
    const windowCenter = window.innerHeight / 2;
    let closestQuestion = null;
    let closestDistance = Infinity;

    questions.forEach(question => {
        const rect = question.getBoundingClientRect();
        const questionCenter = rect.top + (rect.height / 2);
        const distance = Math.abs(questionCenter - windowCenter);
        
        if (distance < closestDistance) {
            closestDistance = distance;
            closestQuestion = question;
        }
    });

    return closestQuestion;
  }

  function handleKeyPress(event) {
    const keyMap = {
        'a': 0,  // First choice
        's': 1,  // Second choice
        'd': 2,  // Third choice
        'f': 3,  // Fourth choice
        'g': 4   // Fifth choice
    };

    if (event.key in keyMap) {
        const centeredQuestion = getMostCenteredQuestion();
        if (centeredQuestion) {
            const inputs = centeredQuestion.querySelectorAll('input[type="radio"]');
            const index = keyMap[event.key];
            if (inputs[index]) {
                inputs[index].click();
            }
        }
    }
  }

  document.addEventListener('keypress', handleKeyPress);

  async function logIncorrectAnswer(mcq_id, factoid) {
    try {
        const response = await fetch('/api/questionbank/log_incorrect', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                'X-API-Key': localStorage.getItem('apiKey')
            },
            credentials: 'include',
            body: JSON.stringify({
                mcq_id: mcq_id,
                factoid: factoid,
                timestamp: new Date().toISOString()
            })
        });
        
        if (!response.ok) {
            const text = await response.text();
            console.error('Error response:', text);
            throw new Error(`Failed to log incorrect answer: ${response.status}`);
        }
    } catch (error) {
        console.error('Error logging incorrect answer:', error);
        showError(`Failed to log incorrect answer: ${error.message}`);
    }
  }

  async function saveAnswer(questionId, selectedAnswer, isCorrect) {
    try {
        console.log('Saving answer:', { questionId, selectedAnswer, isCorrect });
        
        const response = await fetch('/api/questionbank/save-progress', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            credentials: 'include',  // Ensure credentials are included
            body: JSON.stringify({
                questionId,
                selectedAnswer,
                isCorrect,
                timestamp: new Date().toISOString()
            })
        });
        
        if (!response.ok) {
            const text = await response.text();
            console.error('Error response:', text);
            throw new Error(`Failed to save progress: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('Save response:', data);
        
        // If incorrect, log it
        if (!isCorrect) {
            await logIncorrectAnswer(questionId);
        }
        
    } catch (error) {
        console.error('Error saving answer:', error);
        showError(`Failed to save answer: ${error.message}`);
    }
  }

  loadMCQs();
</script>

</body>
</html>