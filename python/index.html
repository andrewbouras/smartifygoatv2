<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>MCQ Viewer</title>
<style>
  body {
    font-family: sans-serif;
    max-width: 600px;
    margin: 20px auto;
    line-height: 1.5;
    background-color: #1a1a1a;
    color: #e0e0e0;
  }
  .question-block {
    border: 1px solid #444;
    padding: 15px;
    margin-bottom: 20px;
    border-radius: 4px;
    background-color: #2a2a2a;
  }
  .question-block h2 {
    margin: 0 0 10px;
    font-size: 1.1rem;
    color: #fff;
  }
  .choices {
    margin-bottom: 10px;
  }
  .choice {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
  }
  .choice input {
    margin-right: 10px;
  }
  .choice label {
    color: #e0e0e0;
  }
  .explanation {
    background: #333;
    padding: 10px;
    border-left: 4px solid #555;
    margin-top: 10px;
    font-size: 0.9rem;
  }
  .correct {
    background-color: #1b3320;
    border-left-color: #2d5a3c;
  }
  .incorrect {
    background-color: #3d2020;
    border-left-color: #5a2d2d;
  }
  .factoid {
    font-size: 0.8rem;
    color: #aaa;
    margin-top: 5px;
  }
</style>
</head>
<body>

<h1>MCQ Practice</h1>
<div id="mcq-container">Loading MCQs...</div>

<script>
  async function loadMCQs() {
    try {
        // Get list of MCQ files - update path to be relative to /mcq
        const response = await fetch('/mcq/mcqs/mcqs.json');
        const data = await response.json();
        
        if (!data.mcqs) {
            throw new Error('Invalid MCQ file format');
        }
        
        displayMCQs(data.mcqs);
    } catch (error) {
        console.error('Error loading MCQs:', error);
        document.getElementById('mcq-container').textContent = 
            'Error loading MCQs: ' + error.message;
    }
  }

  function showExplanation(mcq, block, selectedValue) {
    // Remove existing explanation if any
    const oldExp = block.querySelector('.explanation');
    if (oldExp) oldExp.remove();

    const explanationDiv = document.createElement('div');
    explanationDiv.className = 'explanation';

    const correctChoice = mcq.answerChoices.find(c => c.correct);
    const isCorrect = correctChoice && selectedValue === correctChoice.value;

    if (isCorrect) {
        explanationDiv.classList.add('correct');
        explanationDiv.textContent = 'Correct! ' + mcq.explanation;
    } else {
        explanationDiv.classList.add('incorrect');
        explanationDiv.textContent = 'Incorrect. The correct answer is: ' + 
            (correctChoice ? correctChoice.value : 'No correct answer found') + '. ' + mcq.explanation;
        
        // Log incorrect answer
        logIncorrectAnswer(mcq.id, mcq.factoid);
    }

    // Factoid section
    const factoidDiv = document.createElement('div');
    factoidDiv.className = 'factoid';
    factoidDiv.textContent = 'Factoid: ' + mcq.factoid;

    explanationDiv.appendChild(factoidDiv);
    block.appendChild(explanationDiv);
    
    // Add scroll to next question
    scrollToNextQuestion(block);
  }

  function displayMCQs(mcqs) {
    const container = document.getElementById('mcq-container');
    container.innerHTML = '';
    
    mcqs.forEach((mcq, index) => {
        const block = document.createElement('div');
        block.className = 'question-block';
        
        // Question title
        const qTitle = document.createElement('h2');
        qTitle.textContent = (index + 1) + '. ' + mcq.question;
        block.appendChild(qTitle);
        
        // Choices
        const choicesDiv = document.createElement('div');
        choicesDiv.className = 'choices';
        
        // Sort answer choices alphabetically by value
        const sortedChoices = [...mcq.answerChoices].sort((a, b) => 
            a.value.localeCompare(b.value)
        );
        
        sortedChoices.forEach((choice, choiceIndex) => {
            const choiceDiv = document.createElement('div');
            choiceDiv.className = 'choice';
            
            const input = document.createElement('input');
            input.type = 'radio';
            input.name = 'q' + index;
            input.value = choice.value;
            input.id = 'q' + index + 'c' + choiceIndex;
            
            input.addEventListener('change', () => {
                showExplanation(mcq, block, choice.value);
            });
            
            const label = document.createElement('label');
            label.htmlFor = input.id;
            label.textContent = choice.value;
            
            choiceDiv.appendChild(input);
            choiceDiv.appendChild(label);
            choicesDiv.appendChild(choiceDiv);
        });
        
        block.appendChild(choicesDiv);
        container.appendChild(block);
    });
  }

  function scrollToNextQuestion(block) {
    // Wait 1 second before scrolling
    setTimeout(() => {
        // Get the next question block
        const nextBlock = block.nextElementSibling;
        if (nextBlock && nextBlock.classList.contains('question-block')) {
            // Calculate position to center the next question
            const windowHeight = window.innerHeight;
            const nextBlockRect = nextBlock.getBoundingClientRect();
            const scrollTo = window.pageYOffset + nextBlockRect.top - (windowHeight/2) + (nextBlockRect.height/2);
            
            // Smooth scroll
            window.scrollTo({
                top: scrollTo,
                behavior: 'smooth'
            });
        }
    }, 1000); // 1 second delay
  }

  function getMostCenteredQuestion() {
    const questions = document.querySelectorAll('.question-block');
    const windowCenter = window.innerHeight / 2;
    let closestQuestion = null;
    let closestDistance = Infinity;

    questions.forEach(question => {
        const rect = question.getBoundingClientRect();
        const questionCenter = rect.top + (rect.height / 2);
        const distance = Math.abs(questionCenter - windowCenter);
        
        if (distance < closestDistance) {
            closestDistance = distance;
            closestQuestion = question;
        }
    });

    return closestQuestion;
  }

  function handleKeyPress(event) {
    const keyMap = {
        'a': 0,  // First choice
        's': 1,  // Second choice
        'd': 2,  // Third choice
        'f': 3,  // Fourth choice
        'g': 4   // Fifth choice
    };

    if (event.key in keyMap) {
        const centeredQuestion = getMostCenteredQuestion();
        if (centeredQuestion) {
            const inputs = centeredQuestion.querySelectorAll('input[type="radio"]');
            const index = keyMap[event.key];
            if (inputs[index]) {
                inputs[index].click();
            }
        }
    }
  }

  document.addEventListener('keypress', handleKeyPress);

  async function logIncorrectAnswer(mcq_id, factoid) {
    try {
        const userId = localStorage.getItem('userId'); // Get user ID from localStorage
        await fetch('/log_incorrect', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                mcq_id: mcq_id,
                factoid: factoid,
                userId: userId
            })
        });
    } catch (error) {
        console.error('Error logging incorrect answer:', error);
    }
  }

  loadMCQs();
</script>

</body>
</html>